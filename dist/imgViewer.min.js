/*! jQuery imgViewer - v0.5.0 - 2013-05-07
* Copyright (c) 2013 Wayne Mogg; Licensed MIT */
(function(t){t.widget("wgm.imgViewer",{options:{zoomStep:.1,zoom:1,onClick:null,onUpdate:null},_create:function(){var e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==",i=this;this.element.is("img")||t.error("imgviewer plugin can only be applied to img elements"),i.img=i.element[0];var o=t(i.img);i.zoom=1,i.dragging=!1,o.one("load",function(){var t=o.width(),s=o.height();o.attr("width")&&-1!==o.attr("width").indexOf("%")&&(i.autoWidth=!0,i.autoWidthPercent=parseInt(o.attr("width"),10)),o.attr("height")&&-1!==o.attr("height").indexOf("%")&&(i.autoHeight=!0,i.autoHeightPercent=parseInt(o.attr("height"),10)),i.bgWidth=t,i.bgHeight=s,i.bgAspect=t/s,i.bgCenter={x:t/2,y:s/2},i.offsetBorder={x:parseInt(o.css("border-left-width"),10),y:parseInt(o.css("border-top-width"),10)},i.offsetPadding={x:parseInt(o.css("padding-left"),10),y:parseInt(o.css("padding-top"),10)},i.offset=o.offset(),o.css({background:"url("+i.img.src+") 0 0 no-repeat",backgroundSize:t+"px "+s+"px",backgroundPosition:i.offsetPadding.x+"px "+i.offsetPadding.y+"px"}),i.img.width=t,i.img.height=s,i.img.src=e}),o.mousewheel(function(t,e){t.preventDefault(),i.options.zoom-=e*i.options.zoomStep,i.update()}),o.mousedown(function(t){function e(t){t.preventDefault(),setTimeout(function(){i.dragging=!1},0),o.unbind("mousemove")}t.preventDefault();var s=t;o.mousemove(function(t){t.preventDefault(),i.dragging=!0,i.bgCenter.x=i.bgCenter.x-(t.pageX-s.pageX)/i.options.zoom,i.bgCenter.y=i.bgCenter.y-(t.pageY-s.pageY)/i.options.zoom,s=t,i.update()}),o.one("mouseleave",e),o.one("mouseup",e)}),o.click(function(t){i.dragging||i._trigger("onClick",t,i)}),t(window).resize(function(){if(i.autoWidth||i.autoHeight){var t=o.parent().width(),e=o.parent().height();i.autoWidth&&i.autoHeight?(t=t*i.autoWidthPercent/100,e=e*i.autoHeightPercent/100):i.autoWidth?(t=t*i.autoWidthPercent/100,e=t/i.bgAspect):i.autoHeight&&(e=e*i.autoHeightPercent/100,t=e*i.bgAspect),i.bgCenter.x*=t/i.bgWidth,i.bgCenter.y*=e/i.bgHeight,i.img.width=t,i.img.height=e,i.bgHeight=e,i.bgWidth=t,i.offset=o.offset(),i.update()}})},destroy:function(){var e=t(this.img);e.unbind("click"),e.unmousewheel(),t(window).unbind("resize"),t.Widget.prototype.destroy.call(this)},_setOption:function(e,i){switch(e){case"zoom":if(1>parseFloat(i)||isNaN(parseFloat(i)))return;break;case"zoomStep":if(0>=parseFloat(i)||isNaN(parseFloat(i)))return}var o=t.ui.version.split(".");o[0]>1||o[1]>8?this._super(e,i):t.Widget.prototype._setOption.apply(this,arguments),this.update()},imgToCursor:function(t,e){if(t>=0&&1>=t&&e>=0&&1>=e){var i=this.bgWidth/2-this.bgCenter.x*this.options.zoom,o=this.bgHeight/2-this.bgCenter.y*this.options.zoom,s=t*this.bgWidth*this.options.zoom+this.offset.left+this.offsetPadding.x+this.offsetBorder.x+i,n=e*this.bgHeight*this.options.zoom+this.offset.top+this.offsetPadding.y+this.offsetBorder.y+o;return{pageX:Math.round(s),pageY:Math.round(n)}}return{}},cursorToImg:function(t,e){var i=this.bgWidth/2-this.bgCenter.x*this.options.zoom,o=this.bgHeight/2-this.bgCenter.y*this.options.zoom,s=(t-this.offset.left-this.offsetPadding.x-this.offsetBorder.x-i)/(this.bgWidth*this.options.zoom),n=(e-this.offset.top-this.offsetPadding.y-this.offsetBorder.y-o)/(this.bgHeight*this.options.zoom);return s>=0&&1>=s&&n>=0&&1>=n?{relx:s,rely:n}:{}},update:function(){var e,i,o,s,n=t(this.img),g=this.bgWidth,r=this.bgHeight,h=this.options.zoom,a=g/2,d=r/2;1>=h?(e=0,i=0,o=g,s=r,this.bgCenter={x:a,y:d},this.options.zoom=1):(e=d-this.bgCenter.y*h,i=a-this.bgCenter.x*h,o=g*h,s=r*h,i>0?(this.bgCenter.x=a/h,i=0):g>i+o&&(this.bgCenter.x=g-a/h,i=g-o),e>0?(this.bgCenter.y=d/h,e=0):r>e+s&&(this.bgCenter.y=r-d/h,e=r-s)),n.css({backgroundSize:o+"px "+s+"px",backgroundPosition:i+this.offsetPadding.x+"px "+(e+this.offsetPadding.y)+"px"}),this._trigger("onUpdate",null,this)}})})(jQuery);